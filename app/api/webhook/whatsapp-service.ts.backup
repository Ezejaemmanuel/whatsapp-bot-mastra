import { WhatsAppCloudApiClient } from '@/whatsapp/whatsapp-client';
import { WebhookMessage, WebhookMessageStatus, WebhookPayload } from './types';
import { logWebhookEvent, logSuccess, logError, logWarning, logInfo, extractMessageInfo, extractStatusInfo } from './utils';
import { DatabaseService } from '@/lib/database-service';
import { MediaUploadService } from '@/lib/media-upload-service';
import { Id } from '@/convex/_generated/dataModel';
import { mastra } from '@/mastra';
import { RuntimeContext } from '@mastra/core/runtime-context';
import { TEST_MODE } from '@/constant';
import { HANDLE_IMAGE_AGENT_TEMPRETURE, HANDLE_TEXT_AGENT_TEMPRETURE } from '@/mastra/agents/agent-instructions';
// import { sendDebugMessage } from '@/mastra/tools/utils';
import { WhatsAppClientService } from '@/whatsapp/whatsapp-client-service';
import { Conversation } from '@/lib/schema';
import { analyzeImageDirectly } from '@/mastra/tools/image-analysis-tool';
import { sendDebugMessage } from '@/mastra/tools/utils';
import {
    initializeWebhookService,
    processIncomingMessage,
    processWebhookPayload,
    WebhookServiceConfig
} from './webhook-processor';
import { processStatusUpdate } from './status-handlers';
import {
    sendTextReply,
    sendTemplateMessage,
    markMessageAsRead
} from './response-sender';

/**
 * Format error details for test mode
 */
function formatErrorForTestMode(error: unknown, context: Record<string, any> = {}): string {
    if (!TEST_MODE) {
        return 'I apologize, but I encountered an issue. Please try again in a moment.';
    }

    const errorMessage = error instanceof Error ? error.message : String(error);
    const errorName = error instanceof Error ? error.name : 'Unknown Error';
    const errorStack = error instanceof Error ? error.stack : 'No stack trace available';

    return `üîß TEST MODE - ERROR DETAILS:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚ùå ERROR: ${errorName}
üìù MESSAGE: ${errorMessage}

üìç CONTEXT:
${Object.entries(context).map(([key, value]) => `‚Ä¢ ${key}: ${JSON.stringify(value)}`).join('\n')}

üîç STACK TRACE:
${errorStack}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚ö†Ô∏è This detailed error is only shown in TEST_MODE`;
}

/**
 * WhatsApp Webhook Service - Functional Implementation
 * 
 * This service provides a functional approach to handling WhatsApp webhook events.
 * It's broken down into smaller, focused modules for better maintainability.
 */

// Service state
let serviceInstance: {
    whatsappClient: WhatsAppCloudApiClient;
    databaseService: any;
    mediaUploadService: any;
    phoneNumberId: string;
    clientService: any;
} | null = null;

/**
 * Initialize the WhatsApp webhook service
 */
export function initializeWhatsAppService(config: WebhookServiceConfig = {}) {
    if (!serviceInstance) {
        serviceInstance = initializeWebhookService(config);
    }
    return serviceInstance;
}

/**
 * Get the current service instance
 */
export function getServiceInstance() {
    if (!serviceInstance) {
        throw new Error('WhatsApp service not initialized. Call initializeWhatsAppService() first.');
    }
    return serviceInstance;
}

/**
 * Process incoming webhook message
 */
export async function handleIncomingMessage(
    message: WebhookMessage,
    contactName?: string
): Promise<void> {
    const { whatsappClient, databaseService, mediaUploadService } = getServiceInstance();
    await processIncomingMessage(whatsappClient, databaseService, mediaUploadService, message, contactName);
}

/**
 * Process message status update
 */
export async function handleStatusUpdate(status: WebhookMessageStatus): Promise<void> {
    await processStatusUpdate(status);
}

/**
 * Send a text reply to a message
 */
export async function sendTextMessage(
    to: string,
    text: string,
    replyToMessageId?: string
): Promise<void> {
    const { whatsappClient } = getServiceInstance();
    await sendTextReply(whatsappClient, to, text, replyToMessageId);
}

/**
 * Send a template message
 */
export async function sendTemplate(
    to: string,
    templateName: string,
    languageCode: string,
    components?: any[]
): Promise<void> {
    const { whatsappClient } = getServiceInstance();
    await sendTemplateMessage(whatsappClient, to, templateName, languageCode, components);
}

/**
 * Mark message as read
 */
export async function markAsRead(messageId: string): Promise<void> {
    const { whatsappClient, phoneNumberId } = getServiceInstance();
    await markMessageAsRead(whatsappClient, messageId, phoneNumberId);
}

/**
 * Process complete webhook payload
 */
export async function handleWebhookPayload(payload: WebhookPayload): Promise<void> {
    const { whatsappClient, databaseService, mediaUploadService } = getServiceInstance();
    await processWebhookPayload(whatsappClient, databaseService, mediaUploadService, payload);
}

/**
 * Get the underlying WhatsApp client for advanced operations
 */
export function getWhatsAppClient(): WhatsAppCloudApiClient {
    const { whatsappClient } = getServiceInstance();
    return whatsappClient;
}

/**
 * Update service configuration
 */
export function updateServiceConfig(accessToken?: string, phoneNumberId?: string): void {
    const instance = getServiceInstance();
    if (accessToken || phoneNumberId) {
        instance.clientService.updateConfig(accessToken, phoneNumberId);
        instance.whatsappClient = instance.clientService.getClient();
        if (phoneNumberId) {
            instance.phoneNumberId = phoneNumberId;
        }
    }
}

/**
 * Legacy class-based interface for backward compatibility
 * @deprecated Use the functional interface instead
 */
export class WhatsAppWebhookService {
    private initialized = false;

    constructor(accessToken?: string, phoneNumberId?: string) {
        initializeWhatsAppService({ accessToken, phoneNumberId });
        this.initialized = true;

        logInfo('WhatsApp Webhook Service (Legacy Class) initialized successfully', {
            serviceInitialized: true,
            note: 'Consider migrating to functional interface'
        });
    }

    async processIncomingMessage(message: WebhookMessage, contactName?: string): Promise<void> {
        return handleIncomingMessage(message, contactName);
    }

    async processStatusUpdate(status: WebhookMessageStatus): Promise<void> {
        return handleStatusUpdate(status);
    }

    async sendTextReply(to: string, text: string, replyToMessageId?: string): Promise<void> {
        return sendTextMessage(to, text, replyToMessageId);
    }

    async sendTemplateMessage(
        to: string,
        templateName: string,
        languageCode: string,
        components?: any[]
    ): Promise<void> {
        return sendTemplate(to, templateName, languageCode, components);
    }

    async markMessageAsRead(messageId: string): Promise<void> {
        return markAsRead(messageId);
    }

    async processWebhookPayload(payload: WebhookPayload): Promise<void> {
        return handleWebhookPayload(payload);
    }

    getClient(): WhatsAppCloudApiClient {
        return getWhatsAppClient();
    }

    updateConfig(accessToken?: string, phoneNumberId?: string): void {
        updateServiceConfig(accessToken, phoneNumberId);
    }
}